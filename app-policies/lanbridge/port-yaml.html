<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Port YAML Generator</title>
  </head>
  <body>
    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);

        // 合并 hash 参数到 params
        if (window.location.hash) {
          const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ""));
          for (const [key, value] of hashParams.entries()) {
            if (!params.has(key)) {
              params.set(key, value);
            }
          }
        }

        const ipRaw = params.get("ip");
        const portRaw = params.get("port");
        const ip = ipRaw ? ipRaw.trim() : "";
        const port = portRaw ? portRaw.trim() : "";

        if (!ip || !port) {
          // 没有必要参数就不做任何事
          return;
        }

        let content;
        try {
          // 从当前相对路径读取模板文件 1080.yaml
          const res = await fetch("1080.yaml");
          if (!res.ok) {
            throw new Error("Failed to load 1080.yaml");
          }
          content = await res.text();
        } catch (e) {
          // 读失败就用最小模板兜底
          content = "";
        }

        // 如果有 port 行，就替换（保留缩进）
        if (/^\s*port:/m.test(content)) {
          content = content.replace(
            /^(\s*)port:.*$/gm,
            (_, indent) => `${indent}port: ${port}`
          );
        } else {
          // 没有就加在最前面
          content = `port: ${port}\n` + content;
        }

        // 如果有 server 行，就替换（保留缩进）
        if (/^\s*server:/m.test(content)) {
          content = content.replace(
            /^(\s*)server:.*$/gm,
            (_, indent) => `${indent}server: ${ip}`
          );
        } else {
          // 没有就紧跟在 port 后面加一行
          content = content.replace(/^(port:.*\n)/, `$1server: ${ip}\n`);
          // 如果上面没匹配到（比如 content 为空），再兜底一次
          if (!/^server:/m.test(content)) {
            content += `\nserver: ${ip}\n`;
          }
        }

        // 创建下载
        const blob = new Blob([content], { type: "text/yaml" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `${port}.yaml`; // 如果想一直叫 1080.yaml，这里改成 "1080.yaml"
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      })();
    </script>
  </body>
</html>
