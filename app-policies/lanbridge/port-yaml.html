<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Port YAML Generator</title>
</head>
<body>
<script>
(async () => {
  const params = new URLSearchParams(window.location.search);
  const ip = (params.get("ip") || "").trim();
  const port = (params.get("port") || "").trim();
  if (!ip || !port) return;

  // 读取本地 1080.yaml（适配 GitHub Pages）
  let content = "";
  try {
    const res = await fetch(new URL("1080.yaml", location.href));
    content = await res.text();
  } catch {
    alert("读取 1080.yaml 失败，请检查文件路径或仓库目录");
    return;
  }

  // 按行处理
  const lines = content.split(/\r?\n/);
  let inProxyBlock = false;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // 进入目标 block
    if (line.includes('- name: "Local-NetworkShare"')) {
      inProxyBlock = true;
      continue;
    }

    if (inProxyBlock) {
      // 只替换固定行（你的需求方式）
      if (line.startsWith("    server:")) {
        lines[i] = `    server: ${ip}`;
      }
      if (line.startsWith("    port:")) {
        lines[i] = `    port: ${port}`;
      }

      // 离开 block（遇到下段）
      if (line.startsWith("proxy-groups:") || line.trim() === "") {
        inProxyBlock = false;
      }
    }
  }

  content = lines.join("\n");

  // 下载文件（文件名用端口号）
  const blob = new Blob([content], { type: "text/yaml" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${port}.yaml`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
})();
</script>
</body>
</html>