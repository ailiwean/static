<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Port YAML Generator</title>
  </head>
  <body>
    <script>
      const params = new URLSearchParams(window.location.search);
      if (window.location.hash) {
        const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ""));
        for (const [key, value] of hashParams.entries()) {
          if (!params.has(key)) {
            params.set(key, value);
          }
        }
      }

      const ip = params.get("ip");
      const port = params.get("port");

      const downloadYaml = async () => {
        if (!ip || !port) return;
        const response = await fetch("1080.yaml", { cache: "no-store" });
        const template = await response.text();
        const updated = template
          .replace(/^port:\s*1080$/m, `port: ${port}`)
          .replace(/^socks-port:\s*1080$/m, `socks-port: ${port}`)
          .replace(/^(\s+)port:\s*1080$/m, `$1port: ${port}`)
          .replace(/^(\s+)server:\s*.+$/m, `$1server: ${ip}`);
        const blob = new Blob([updated], { type: "text/yaml" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `${port}.yaml`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      void downloadYaml();
    </script>
  </body>
</html>
